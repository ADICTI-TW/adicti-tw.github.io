<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arduino Serial è¨­å®šå·¥å…·</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: #f4f7f9; margin: 0; padding: 1rem; color: #333;
        }
        .card { 
            background: white; padding: 1.5rem; border-radius: 16px; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto;
        }
        h2 { margin-top: 0; text-align: center; color: #1a73e8; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        button { 
            flex: 1; padding: 12px; border: none; border-radius: 8px; 
            font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        #btnConnect { background: #1a73e8; color: white; }
        #btnDisconnect { background: #ea4335; color: white; display: none; }
        #btnSave { background: #34a853; color: white; width: 100%; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; }
        input { 
            width: 100%; padding: 10px; border: 1px solid #ddd; 
            border-radius: 6px; box-sizing: border-box; font-size: 1rem;
        }
        #status { 
            margin: 15px 0; padding: 12px; border-radius: 8px; 
            display: none; font-size: 0.9rem; line-height: 1.4;
        }
        .success { background: #e6f4ea; color: #137333; border: 1px solid #ceead6; }
        .error { background: #fce8e6; color: #c5221f; border: 1px solid #fad2cf; }
        .log { 
            background: #202124; color: #f1f3f4; padding: 12px; 
            border-radius: 8px; font-family: monospace; font-size: 0.8rem;
            max-height: 150px; overflow-y: auto; white-space: pre-wrap;
        }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ¤– è¨­å®šåŠ©æ‰‹ (Serial)</h2>
    
    <div class="btn-group">
        <button id="btnConnect">ğŸ”Œ é€£æ¥è¨­å‚™</button>
        <button id="btnDisconnect">âŒ æ–·é–‹</button>
    </div>

    <div id="settingsPanel" style="opacity: 0.5; pointer-events: none;">
        <div class="form-group">
            <label>WiFi SSID:</label>
            <input type="text" id="ssid" placeholder="ä¾‹å¦‚: MyHome_WiFi">
        </div>
        <div class="form-group">
            <label>Baud Rate (Flash å„²å­˜å€¼):</label>
            <input type="number" id="baud" value="115200">
        </div>
        <div class="form-group">
            <label>å‚™è¨» (Memo):</label>
            <input type="text" id="memo" placeholder="è¼¸å…¥å‚™è¨»å…§å®¹">
        </div>
        <button id="btnSave">ğŸ’¾ ç™¼é€ä¸¦é©—è­‰</button>
    </div>

    <div id="status"></div>
    <div class="log" id="logArea">ç­‰å¾…é€£ç·šä¸­...</div>
</div>

<script>
    let port;
    let reader;
    let keepReading = true;

    const btnConnect = document.getElementById('btnConnect');
    const btnDisconnect = document.getElementById('btnDisconnect');
    const btnSave = document.getElementById('btnSave');
    const settingsPanel = document.getElementById('settingsPanel');
    const statusDiv = document.getElementById('status');
    const logArea = document.getElementById('logArea');

    // --- é€£æ¥é‚è¼¯ ---
    btnConnect.addEventListener('click', async () => {
        if (!("serial" in navigator)) {
            alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Web Serial APIã€‚è«‹ç¢ºä¿ä½¿ç”¨ Chrome ä¸¦åœ¨ Android ä¸Šé–‹å•Ÿç›¸é—œ Flagsã€‚");
            return;
        }

        try {
            // 1. è«‹æ±‚åºåˆ—åŸ 
            port = await navigator.serial.requestPort();
            // 2. é–‹å•Ÿåºåˆ—åŸ  (Arduino ä¸€èˆ¬é è¨­ 9600 æˆ– 115200)
            await port.open({ baudRate: 9600 }); 
            
            toggleUI(true);
            log("âœ… å·²é€£æ¥åˆ°è¨­å‚™");
            
            // 3. å•Ÿå‹•è®€å–å¾ªç’°
            readLoop();

        } catch (error) {
            log("âŒ é€£æ¥å¤±æ•—: " + error.message);
        }
    });

    // --- æ–·é–‹é‚è¼¯ ---
    btnDisconnect.addEventListener('click', async () => {
        keepReading = false;
        if (reader) {
            await reader.cancel();
        }
        if (port) {
            await port.close();
        }
        toggleUI(false);
        log("ğŸ”Œ å·²ä¸­æ–·é€£ç·š");
    });

    // --- ç™¼é€ JSON è³‡æ–™ ---
    btnSave.addEventListener('click', async () => {
        if (!port || !port.writable) return;

        const data = {
            ssid: document.getElementById('ssid').value,
            baud: parseInt(document.getElementById('baud').value),
            memo: document.getElementById('memo').value
        };

        const jsonString = JSON.stringify(data) + "\n";
        const encoder = new TextEncoder();
        const writer = port.writable.getWriter();

        try {
            await writer.write(encoder.encode(jsonString));
            log("TX >> " + jsonString.trim());
            showStatus("è³‡æ–™å·²ç™¼é€ï¼Œç­‰å¾…é©—è­‰...", "");
        } catch (error) {
            log("âŒ ç™¼é€å¤±æ•—: " + error.message);
        } finally {
            writer.releaseLock();
        }
    });

    // --- è®€å–å¾ªç’° ---
    async function readLoop() {
        keepReading = true;
        while (port.readable && keepReading) {
            reader = port.readable.getReader();
            try {
                let buffer = "";
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const chunk = new TextDecoder().decode(value);
                    buffer += chunk;

                    // è™•ç†æ›è¡Œç¬¦
                    if (buffer.includes("\n")) {
                        const lines = buffer.split("\n");
                        // æœ€å¾Œä¸€å€‹å…ƒç´ å¯èƒ½æ˜¯å®Œæ•´è¡Œä¹Ÿå¯èƒ½æ˜¯æ®˜ç¼ºè¡Œï¼Œä¿ç•™çµ¦ä¸‹ä¸€æ¬¡
                        buffer = lines.pop(); 
                        
                        for (let line of lines) {
                            line = line.trim();
                            if (line) {
                                log("RX << " + line);
                                handleArduinoResponse(line);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error("Read error:", error);
            } finally {
                reader.releaseLock();
            }
        }
    }

    // --- è§£æå›æ‡‰ ---
    function handleArduinoResponse(line) {
        // è³‡æ–™æ¸…æ´—ï¼šå°‹æ‰¾ç¬¬ä¸€å€‹ '{'
        const start = line.indexOf('{');
        if (start === -1) return;
        const jsonPart = line.substring(start);

        try {
            const resp = JSON.parse(jsonPart);
            if (resp.status === "success") {
                showStatus(`âœ… å„²å­˜æˆåŠŸï¼\nSSID: ${resp.read_ssid}\nMemo: ${resp.read_memo}`, "success");
            } else {
                showStatus(`âŒ éŒ¯èª¤: ${resp.msg}`, "error");
            }
        } catch (e) {
            // é JSON æˆ–æ ¼å¼éŒ¯èª¤
        }
    }

    // --- UI è¼”åŠ©å‡½å¼ ---
    function toggleUI(connected) {
        btnConnect.style.display = connected ? 'none' : 'block';
        btnDisconnect.style.display = connected ? 'block' : 'none';
        settingsPanel.style.opacity = connected ? "1" : "0.5";
        settingsPanel.style.pointerEvents = connected ? "auto" : "none";
        statusDiv.style.display = 'none';
    }

    function showStatus(msg, type) {
        statusDiv.style.display = 'block';
        statusDiv.innerText = msg;
        statusDiv.className = type;
    }

    function log(msg) {
        const t = new Date().toLocaleTimeString('zh-TW', {hour12:false});
        logArea.textContent += `[${t}] ${msg}\n`;
        logArea.scrollTop = logArea.scrollHeight;
    }
</script>

</body>
</html>