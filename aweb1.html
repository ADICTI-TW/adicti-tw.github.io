<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Web Serial è¨­å®šå·¥å…· (Mobile)</title>
    <style>
        /* æ‰‹æ©Ÿç‰ˆé¢å„ªåŒ– CSS */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f0f2f5; 
            margin: 0; 
            padding: 1rem; 
            color: #333;
        }
        .card { 
            background: white; 
            padding: 1.5rem; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            max-width: 100%; /* ç¢ºä¿ä¸è¶…å‡ºæ‰‹æ©Ÿè¢å¹• */
            margin: 0 auto;
        }
        h2 { margin-top: 0; font-size: 1.5rem; text-align: center; }
        
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.95rem; }
        
        /* è¼¸å…¥æ¡†åŠ å¤§ï¼Œæ–¹ä¾¿é»æ“Š */
        input { 
            width: 100%; 
            padding: 0.8rem; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-size: 1rem; 
            background: #fafafa;
        }
        input:focus { border-color: #007bff; outline: none; background: #fff; }

        /* æŒ‰éˆ•å„ªåŒ–ï¼šå…¨å¯¬åº¦ã€å¤§é»æ“Šå€åŸŸ */
        button { 
            width: 100%; 
            padding: 1rem; 
            border: none; 
            border-radius: 8px; 
            font-size: 1.1rem; 
            font-weight: bold; 
            cursor: pointer; 
            transition: opacity 0.2s;
            margin-bottom: 0.5rem;
        }
        button:active { opacity: 0.8; }
        #btnConnect { background: #007bff; color: white; box-shadow: 0 4px 6px rgba(0,123,255,0.2); }
        #btnSave { background: #28a745; color: white; margin-top: 1rem; box-shadow: 0 4px 6px rgba(40,167,69,0.2); }
        button:disabled { background: #e0e0e0; color: #999; box-shadow: none; cursor: not-allowed; }

        #status { margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none; text-align: center; font-weight: bold; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        
        /* Log å€åŸŸåœ¨æ‰‹æ©Ÿä¸Šé è¨­ç¸®å°ï¼Œéœ€è¦æ™‚å¯æ»‘å‹• */
        .log { 
            margin-top: 20px; 
            font-family: monospace; 
            font-size: 0.85em; 
            color: #666; 
            white-space: pre-wrap; 
            background: #eee;
            padding: 0.8rem;
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
        }

        /* é‡å°ä¸æ”¯æ´ API çš„ç€è¦½å™¨é¡¯ç¤ºè­¦å‘Š */
        #unsupported {
            display: none;
            background: #ffecb3;
            color: #663c00;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
        }
    </style>
</head>
<body>

<div id="unsupported">âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Web Serial APIã€‚<br>è«‹ä½¿ç”¨ Android Chrome 89+ã€‚</div>

<div class="card">
    <h2>ğŸ“± Arduino è¨­å®šå·¥å…·</h2>
    
    <div>
        <button id="btnConnect">ğŸ”Œ é€£æ¥ USB OTG è¨­å‚™</button>
    </div>

    <div id="settingsPanel" style="opacity: 0.5; pointer-events: none;">
        <div class="form-group">
            <label for="ssid">WiFi SSID:</label>
            <input type="text" id="ssid" placeholder="è¼¸å…¥ WiFi åç¨±">
        </div>
        <div class="form-group">
            <label for="baud">Baud Rate:</label>
            <input type="number" id="baud" value="9600">
        </div>
        <div class="form-group">
            <label for="memo">å‚™è¨» (Memo):</label>
            <input type="text" id="memo" placeholder="ä»»æ„å‚™è¨»">
        </div>
        
        <button id="btnSave" disabled>ğŸ’¾ å„²å­˜ä¸¦é©—è­‰</button>
    </div>

    <div id="status"></div>
    <div class="log" id="logArea">ç­‰å¾…é€£æ¥...</div>
</div>

<script>
    // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´åº¦
    if (!("serial" in navigator)) {
        document.getElementById('unsupported').style.display = 'block';
        document.getElementById('btnConnect').disabled = true;
    }

    let port;
    let inputBuffer = "";

    const btnConnect = document.getElementById('btnConnect');
    const btnSave = document.getElementById('btnSave');
    const settingsPanel = document.getElementById('settingsPanel');
    const statusDiv = document.getElementById('status');
    const logArea = document.getElementById('logArea');

    // å®šç¾©å¸¸è¦‹ Arduino USB æ™¶ç‰‡çš„ Vendor IDï¼Œå¹«åŠ© Android éæ¿¾è¨­å‚™
    // 0x2341: Arduino Original
    // 0x1A86: CH340 (å¸¸è¦‹å‰¯å» )
    // 0x10C4: CP210x (Silicon Labs)
    // 0x0403: FTDI
    const usbFilters = [
        { usbVendorId: 0x2341 },
        { usbVendorId: 0x1a86 },
        { usbVendorId: 0x10c4 },
        { usbVendorId: 0x0403 }
    ];

    btnConnect.addEventListener('click', async () => {
        try {
            // åœ¨ Android ä¸Šï¼ŒrequestPort å»ºè­°å¸¶å…¥ filtersï¼Œä½†ç‚ºäº†ç›¸å®¹æ€§ï¼Œæˆ‘å€‘å…ˆå˜—è©¦ä¸å¸¶ filter
            // å¦‚æœæ‚¨ç™¼ç¾æ‰¾ä¸åˆ°è¨­å‚™ï¼Œå¯ä»¥æ”¹ç”¨ï¼š port = await navigator.serial.requestPort({ filters: usbFilters });
            port = await navigator.serial.requestPort();
            
            await port.open({ baudRate: 115200 });
            
            btnConnect.textContent = "âœ… å·²é€é OTG é€£æ¥";
            btnConnect.disabled = true;
            settingsPanel.style.opacity = "1";
            settingsPanel.style.pointerEvents = "auto";
            btnSave.disabled = false;
            
            log("Serial Port å·²é–‹å•Ÿï¼Œé–‹å§‹ç›£è½...");
            readLoop();

        } catch (err) {
            console.error(err);
            // é‡å° Android å¸¸è¦‹éŒ¯èª¤æä¾›å…·é«”å»ºè­°
            if (err.name === 'NotFoundError') {
                alert("æ‰¾ä¸åˆ°è¨­å‚™ã€‚\nè«‹ç¢ºèªï¼š\n1. OTG ç·šå·²æ’å¥½\n2. è‹¥æ˜¯ OPPO/Vivo/Realme æ‰‹æ©Ÿï¼Œè«‹åˆ°è¨­å®šé–‹å•Ÿã€ŒOTG é€£æ¥ã€\n3. æˆæ¬Šè¦–çª—è«‹é»é¸å…è¨±");
            } else {
                alert("é€£æ¥å¤±æ•—: " + err.message);
            }
        }
    });

    btnSave.addEventListener('click', async () => {
        if (!port || !port.writable) return;

        const data = {
            ssid: document.getElementById('ssid').value,
            baud: parseInt(document.getElementById('baud').value),
            memo: document.getElementById('memo').value
        };

        const jsonString = JSON.stringify(data);
        log(`ç™¼é€: ${jsonString}`);
        showStatus("å¯«å…¥ä¸­...", "normal");

        try {
            const textEncoder = new TextEncoder();
            const writer = port.writable.getWriter();
            await writer.write(textEncoder.encode(jsonString + "\n"));
            writer.releaseLock();
        } catch (e) {
            log("ç™¼é€éŒ¯èª¤: " + e);
            alert("ç™¼é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ OTG é€£æ¥æ˜¯å¦é¬†å‹•");
        }
    });

    async function readLoop() {
        const textDecoder = new TextDecoderStream();
        // æ•ç²éŒ¯èª¤ä»¥é˜²æ­¢æ‰‹æ©Ÿä¼‘çœ æˆ–æ–·ç·šå°è‡´ crash
        try {
            const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
            const reader = textDecoder.readable.getReader();
            
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                if (value) handleSerialData(value);
            }
        } catch (error) {
            log("è®€å–éŒ¯èª¤ (å¯èƒ½è¨­å‚™å·²æ–·é–‹): " + error);
            btnConnect.disabled = false;
            btnConnect.textContent = "ğŸ”Œ é‡æ–°é€£æ¥";
            settingsPanel.style.opacity = "0.5";
            settingsPanel.style.pointerEvents = "none";
        }
    }

    function handleSerialData(chunk) {
        inputBuffer += chunk;
        let eolIndex;
        while ((eolIndex = inputBuffer.indexOf('\n')) >= 0) {
            const line = inputBuffer.slice(0, eolIndex).trim();
            inputBuffer = inputBuffer.slice(eolIndex + 1);
            if (line.length > 0) parseArduinoResponse(line);
        }
    }

    function parseArduinoResponse(jsonStr) {
        log(`RX: ${jsonStr}`);
        try {
            const response = JSON.parse(jsonStr);
            if (response.status === "success") {
                // æ ¼å¼åŒ–é¡¯ç¤ºé©—è­‰è³‡è¨Š
                let msg = `âœ… å„²å­˜æˆåŠŸ (Flash é©—è­‰ OK)\n`;
                msg += `SSID: ${response.read_ssid}\n`;
                msg += `Baud: ${response.read_baud}`;
                showStatus(msg, "success");
            } else if (response.status === "error") {
                showStatus(`âŒ éŒ¯èª¤: ${response.msg}`, "error");
            }
        } catch (e) {
            // å¿½ç•¥é JSON è¨Šæ¯
        }
    }

    function showStatus(msg, type) {
        statusDiv.style.display = 'block';
        statusDiv.innerText = msg; // ä½¿ç”¨ innerText è®“ \n æ›è¡Œç”Ÿæ•ˆ
        statusDiv.className = type === 'success' ? 'success' : (type === 'error' ? 'error' : '');
    }

    function log(msg) {
        const time = new Date().toLocaleTimeString();
        logArea.textContent += `[${time}] ${msg}\n`;
        logArea.scrollTop = logArea.scrollHeight;
    }
</script>

</body>
</html>