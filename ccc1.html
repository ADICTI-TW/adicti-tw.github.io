<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arduino JSON è¨­å®šå·¥å…· (Universal Serial)</title>
    <style>
        /* æ‰‹æ©Ÿèˆ‡æ¡Œé¢é€šç”¨å„ªåŒ– CSS */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f0f2f5; 
            margin: 0; 
            padding: 1rem; 
            color: #333;
        }
        .card { 
            background: white; 
            padding: 1.5rem; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            max-width: 600px;
            margin: 0 auto;
        }
        h2 { margin-top: 0; font-size: 1.5rem; text-align: center; color: #2c3e50; }
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.95rem; }
        input { 
            width: 100%; padding: 0.8rem; border: 1px solid #ddd; 
            border-radius: 8px; box-sizing: border-box; font-size: 1rem; background: #fafafa;
            transition: border 0.3s;
        }
        input:focus { border-color: #007bff; outline: none; }
        
        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group { display: flex; gap: 10px; margin-bottom: 1.5rem; }
        button { 
            flex: 1; padding: 1rem; border: none; border-radius: 8px; 
            font-size: 1rem; font-weight: bold; cursor: pointer; 
            transition: opacity 0.2s;
        }
        button:active { opacity: 0.8; }
        
        #btnConnect { background: #007bff; color: white; }
        #btnDisconnect { background: #dc3545; color: white; display: none; }
        #btnSave { background: #28a745; color: white; width: 100%; margin-top: 1rem; }
        button:disabled { background: #e0e0e0; color: #999; cursor: not-allowed; }

        #status { margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none; text-align: center; font-weight: bold; white-space: pre-wrap;}
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        .log { 
            margin-top: 20px; font-family: 'Courier New', monospace; font-size: 0.85em; 
            color: #555; white-space: pre-wrap; background: #eee; 
            padding: 0.8rem; border-radius: 8px; max-height: 200px; overflow-y: auto;
        }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ› ï¸ Arduino åƒæ•¸è¨­å®š</h2>
    
    <div class="btn-group">
        <button id="btnConnect">ğŸ”Œ é€£æ¥è¨­å‚™</button>
        <button id="btnDisconnect">âŒ æ–·é–‹</button>
    </div>

    <div id="settingsPanel" style="opacity: 0.5; pointer-events: none;">
        <div class="form-group">
            <label for="ssid">WiFi SSID (å­—ä¸²):</label>
            <input type="text" id="ssid" placeholder="è¼¸å…¥ WiFi åç¨±">
        </div>
        <div class="form-group">
            <label for="baud">ç›®æ¨™ Baud Rate (å„²å­˜å€¼):</label>
            <input type="number" id="baud" value="115200">
            <small style="color:#666; display:block; margin-top:4px;">* æ­¤æ•¸å€¼å°‡å­˜å…¥ Flashï¼Œä¸å½±éŸ¿ç•¶å‰ USB é€£ç·šé€Ÿåº¦</small>
        </div>
        <div class="form-group">
            <label for="memo">å‚™è¨» (Memo):</label>
            <input type="text" id="memo" placeholder="ä»»æ„å‚™è¨»">
        </div>
        
        <button id="btnSave" disabled>ğŸ’¾ ç™¼é€ä¸¦å„²å­˜ (JSON)</button>
    </div>

    <div id="status"></div>
    <div class="log" id="logArea">ç­‰å¾…é€£æ¥... (æ”¯æ´ CDC èˆ‡ CH340)</div>
</div>

<script>
    // --- 1. é©…å‹•å¸¸æ•¸å®šç¾© ---
    const CDC_ACM_INTERFACE_CLASS = 0x0A;
    const CH340_VID = 0x1A86;
    const TRANSFER_SIZE = 64; 

    // --- 2. å…¨åŸŸç‹€æ…‹è®Šæ•¸ ---
    let device;
    let controlInterface;
    let endpointIn; 
    let endpointOut; 
    let readerLoopRunning = false;
    let deviceType = null; // 'CDC' æˆ– 'CH340'
    let inputBuffer = "";  // ç”¨æ–¼è™•ç†æ–·è¡Œç²˜åŒ…

    // --- 3. DOM å…ƒç´  ---
    const btnConnect = document.getElementById('btnConnect');
    const btnDisconnect = document.getElementById('btnDisconnect');
    const btnSave = document.getElementById('btnSave');
    const settingsPanel = document.getElementById('settingsPanel');
    const statusDiv = document.getElementById('status');
    const logArea = document.getElementById('logArea');

    // --- 4. é€£æ¥æŒ‰éˆ•äº‹ä»¶ (æ ¸å¿ƒé‚è¼¯) ---
    btnConnect.addEventListener('click', async () => {
        try {
            // è«‹æ±‚ USB æ¬Šé™ (ç„¡éæ¿¾å™¨ï¼Œé¡¯ç¤ºæ‰€æœ‰ USB è¨­å‚™)
            device = await navigator.usb.requestDevice({ filters: [] });
            log(`é¸ä¸­è£ç½® VID: 0x${device.vendorId.toString(16)}`);

            await device.open();
            if (device.configuration === null) {
                await device.selectConfiguration(1);
            }

            // åˆ¤æ–·æ™¶ç‰‡é¡å‹ä¸¦åˆå§‹åŒ–
            if (device.vendorId === CH340_VID) {
                log("åµæ¸¬åˆ° CH340 æ™¶ç‰‡ï¼Œè¼‰å…¥é©…å‹•...");
                await initializeCH340();
                deviceType = 'CH340';
            } else {
                log("åµæ¸¬åˆ°æ¨™æº– CDC è¨­å‚™ï¼Œè¼‰å…¥é©…å‹•...");
                await initializeCDC();
                deviceType = 'CDC';
            }

            // UI æ›´æ–°
            readerLoopRunning = true;
            readLoop(); // å•Ÿå‹•è®€å–åŸ·è¡Œç·’
            toggleUI(true);
            log(`âœ… é€£æ¥æˆåŠŸ (${deviceType}) - Baud 9600`);

        } catch (error) {
            console.error(error);
            showStatus(`é€£æ¥å¤±æ•—: ${error.message}`, "error");
            disconnectUSB();
        }
    });

    btnDisconnect.addEventListener('click', disconnectUSB);

    // --- 5. ç™¼é€æ•¸æ“š (JSON) ---
    btnSave.addEventListener('click', async () => {
        if (!device || !device.opened || !endpointOut) return;

        const data = {
            ssid: document.getElementById('ssid').value,
            baud: parseInt(document.getElementById('baud').value),
            memo: document.getElementById('memo').value
        };

        const jsonString = JSON.stringify(data);
        log(`TX >> ${jsonString}`);
        showStatus("æ­£åœ¨å¯«å…¥...", "normal");

        const textEncoder = new TextEncoder();
        // é‡è¦ï¼šåŠ ä¸Šæ›è¡Œç¬¦ \nï¼Œå› ç‚º Arduino Serial.readStringUntil('\n') éœ€è¦å®ƒ
        const payload = textEncoder.encode(jsonString + "\n");
        
        // --- é™¤éŒ¯ç”¨ï¼šè®“ä½ çœ‹ä¸€ä¸‹åˆ°åº•é€å‡ºäº†ä»€éº¼ ---
        // ä½ æœƒç™¼ç¾ payload æ˜¯ä¸€å€‹æ•¸å­—é™£åˆ—ï¼Œé€™æ˜¯æ­£å¸¸çš„ USB æ ¼å¼
        console.log("å¯¦éš›ç™¼é€çš„ Bytes:", payload);

        try {
            await device.transferOut(endpointOut.endpointNumber, payload);
        } catch (error) {
            log("å¯«å…¥éŒ¯èª¤: " + error);
            showStatus("å¯«å…¥å¤±æ•—", "error");
        }
    });

    // --- 6. è®€å–è¿´åœˆ (é€šç”¨) ---
    // --- æ›¿æ›åŸæœ¬çš„ readLoop ---
    async function readLoop() {
        inputBuffer = "";
        
        log("ğŸ”µ é™¤éŒ¯æ¨¡å¼å•Ÿå‹•: é¡¯ç¤ºæ‰€æœ‰åŸå§‹è³‡æ–™...");

        while (readerLoopRunning && device && device.opened) {
            try {
                // ç­‰å¾…æ•¸æ“š
                const result = await device.transferIn(endpointIn.endpointNumber, TRANSFER_SIZE);

                if (result.status === 'ok' && result.data.byteLength > 0) {
                    // 1. ç›´æ¥è§£ç¢¼é¡¯ç¤ºï¼Œä¸é€²è¡Œç·©è¡è™•ç†
                    const chunk = new TextDecoder().decode(result.data);
                    
                    // 2. åœ¨ç•«é¢ä¸Šå°å‡ºåŸå§‹æ”¶åˆ°çš„ç‰‡æ®µ
                    // å¦‚æœçœ‹åˆ°äº‚ç¢¼ -> Baud Rate éŒ¯èª¤
                    // å¦‚æœçœ‹åˆ° JSON ä½†åˆ†å¾ˆå¤šæ®µ -> æ­£å¸¸ï¼Œåªæ˜¯ä¹‹å‰çš„é‚è¼¯åœ¨ç­‰ \n
                    log(`[RAW] ${chunk}`); 
                    
                    // 3. ä¾èˆŠä¿ç•™åŸæœ¬çš„æ‹¼æ¹Šé‚è¼¯ä»¥æ¸¬è©¦å®Œæ•´æ€§
                    handleSerialData(chunk);
                }
            } catch (error) {
                if (readerLoopRunning) {
                    console.error("è®€å–éŒ¯èª¤:", error);
                }
            }
        }
    }

    // --- 7. è³‡æ–™è™•ç† (æ‹¼æ¹Šèˆ‡è§£æ) ---
    function handleSerialData(chunk) {
        inputBuffer += chunk;
        
        // å°‹æ‰¾æ›è¡Œç¬¦è™Ÿ (Arduino println)
        let eolIndex;
        while ((eolIndex = inputBuffer.indexOf('\n')) >= 0) {
            // å–å‡ºä¸€è¡Œ
            const line = inputBuffer.slice(0, eolIndex).trim();
            // æ›´æ–° Buffer (ç§»é™¤å·²è™•ç†çš„è¡Œ)
            inputBuffer = inputBuffer.slice(eolIndex + 1);
            
            if (line.length > 0) {
                parseArduinoResponse(line);
            }
        }
    }

    // è§£æ JSON å›æ‡‰
    function parseArduinoResponse(jsonStr) {
        log(`RX << ${jsonStr}`);
        try {
            const response = JSON.parse(jsonStr);
            
            if (response.status === "success") {
                let msg = `âœ… å„²å­˜æˆåŠŸï¼Flash é©—è­‰ç„¡èª¤\n`;
                msg += `SSID: ${response.read_ssid}\n`;
                msg += `Baud: ${response.read_baud}\n`;
                msg += `Memo: ${response.read_memo}`;
                showStatus(msg, "success");
            } else if (response.status === "error") {
                showStatus(`âŒ Arduino å›å ±éŒ¯èª¤: ${response.msg}`, "error");
            }
        } catch (e) {
            // å¿½ç•¥é JSON çš„é™¤éŒ¯è¨Šæ¯
            // log(`(Log) ${jsonStr}`);
        }
    }

    // --- 8. é©…å‹•åˆå§‹åŒ–: CH340 ---
    async function initializeCH340() {
        const ch340Interface = device.configuration.interfaces[0];
        controlInterface = ch340Interface.interfaceNumber;
        await device.claimInterface(controlInterface);
        
        const endpoints = ch340Interface.alternates[0].endpoints;
        endpointIn = endpoints.find(e => e.direction === 'in');
        endpointOut = endpoints.find(e => e.direction === 'out');
        
        if (!endpointIn || !endpointOut) throw new Error("ç„¡æ•ˆçš„ CH340 ç«¯é»çµæ§‹");

        // CH340 è¨­å®šåºåˆ— (BaudRate 9600)
        // è¨»ï¼šè‹¥è¦æ”¹æˆ 115200ï¼Œéœ€æ›´æ”¹ 0xCC90 é€™å€‹ Magic Number
        await vendorReq(0xA1, 0, 0);
        await vendorReq(0x95, 0, 0);
        await vendorReq(0x9A, 0x1312, 0xCC90); // 0xCC90 = 9600 baud, 0xCC00 ~= 115200 (CH340 ç®—æ³•è¤‡é›œï¼Œå»ºè­° Arduino ç«¯é…åˆç”¨ 9600)
        await vendorReq(0x9C, 0x2527, 0);      // 8N1
        await vendorReq(0x95, 0x0706, 0);
        await vendorReq(0x95, 0x0706, 0);
    }
    
    async function vendorReq(req, val, idx) {
        return device.controlTransferOut({
            requestType: 'vendor', recipient: 'device',
            request: req, value: val, index: idx
        });
    }

    // --- 9. é©…å‹•åˆå§‹åŒ–: CDC-ACM (æ¨™æº– Serial) ---
    async function initializeCDC() {
        // å°‹æ‰¾ Class 0x0A (Data Interface)
        const cdcInterface = device.configuration.interfaces.find(i => 
            i.alternates.some(a => a.interfaceClass === CDC_ACM_INTERFACE_CLASS)
        );
        
        // å¦‚æœæ‰¾ä¸åˆ°æ¨™æº– CDC Data Classï¼Œå˜—è©¦ fallback åˆ°ä»‹é¢ 1 (å¸¸è¦‹æ–¼ Arduino)
        const targetInterface = cdcInterface || device.configuration.interfaces[1] || device.configuration.interfaces[0];
        
        if (!targetInterface) throw new Error("æ‰¾ä¸åˆ° Serial ä»‹é¢");

        controlInterface = targetInterface.interfaceNumber;
        await device.claimInterface(controlInterface);

        const endpoints = targetInterface.alternates[0].endpoints;
        endpointIn = endpoints.find(e => e.direction === 'in');
        endpointOut = endpoints.find(e => e.direction === 'out');

        // è¨­å®š BaudRate 9600 (CDC æ¨™æº–æŒ‡ä»¤)
        // [0x80, 0x25, 0x00, 0x00, 0x00, 0x00, 0x08] => 9600
        // [0x00, 0xC2, 0x01, 0x00, 0x00, 0x00, 0x08] => 115200 (ç¯„ä¾‹)
        // é€™è£¡ç¶­æŒ 9600 ä»¥ç¢ºä¿ç©©å®š
        const baudRate = new Uint8Array([0x80, 0x25, 0x00, 0x00, 0x00, 0x00, 0x08]); 
        
        // æ³¨æ„ï¼šCDC è¨­å®šé€šå¸¸éœ€è¦ç™¼é€åˆ° Control Interface (é€šå¸¸æ˜¯ Interface 0)ï¼Œä½†æŸäº›å¯¦ä½œå…è¨±ç™¼é€åˆ° Data Interface
        // ç‚ºäº†é€šç”¨æ€§ï¼Œé€™è£¡ç°¡åŒ–è™•ç†ã€‚è‹¥ Arduino Micro/Leonardo æ²’åæ‡‰ï¼Œå¯èƒ½éœ€è¦é‡å° Interface 0 ç™¼é€ Class Request
        await device.controlTransferOut({
            requestType: 'class', recipient: 'interface',
            request: 0x20, value: 0, index: controlInterface
        }, baudRate).catch(e => console.warn("BaudSet Warning:", e));

        // DTR/RTS On (é–‹å•Ÿé€šè¨Š)
        await device.controlTransferOut({
            requestType: 'class', recipient: 'interface',
            request: 0x22, value: 0x03, index: controlInterface
        }).catch(e => console.warn("DTR Warning:", e));
    }

    // --- 10. æ–·é–‹èˆ‡ UI è¼”åŠ© ---
    async function disconnectUSB() {
        readerLoopRunning = false;
        if (device) {
            try {
                if (deviceType === 'CDC') {
                    // å˜—è©¦é—œé–‰ DTR
                    await device.controlTransferOut({
                        requestType: 'class', recipient: 'interface',
                        request: 0x22, value: 0x00, index: controlInterface
                    }).catch(()=>{});
                }
                await device.releaseInterface(controlInterface).catch(()=>{});
                await device.close().catch(()=>{});
            } catch(e) { console.log(e); }
        }
        device = null;
        toggleUI(false);
        log("å·²æ–·é–‹é€£æ¥");
    }

    function toggleUI(connected) {
        btnConnect.style.display = connected ? 'none' : 'block';
        btnDisconnect.style.display = connected ? 'block' : 'none';
        settingsPanel.style.opacity = connected ? "1" : "0.5";
        settingsPanel.style.pointerEvents = connected ? "auto" : "none";
        btnSave.disabled = !connected;
    }

    function showStatus(msg, type) {
        statusDiv.style.display = 'block';
        statusDiv.textContent = msg;
        statusDiv.className = type;
        
        if (type === 'success') {
            setTimeout(() => { statusDiv.style.display = 'none'; }, 4000);
        }
    }

    function log(msg) {
        const time = new Date().toLocaleTimeString('zh-TW', {hour12: false});
        logArea.textContent += `[${time}] ${msg}\n`;
        logArea.scrollTop = logArea.scrollHeight;
    }
</script>

</body>
</html>