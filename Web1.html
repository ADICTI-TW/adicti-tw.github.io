<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Serial JSON è¨­å®šå·¥å…·</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; background: #f4f4f9; }
        .card { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #333; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        input { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { padding: 0.7rem 1.5rem; cursor: pointer; border: none; border-radius: 4px; font-size: 1rem; }
        #btnConnect { background: #007bff; color: white; }
        #btnSave { background: #28a745; color: white; margin-top: 1rem; width: 100%; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #status { margin-top: 1rem; padding: 1rem; border-radius: 4px; display: none; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .log { margin-top: 20px; font-family: monospace; font-size: 0.9em; color: #666; white-space: pre-wrap; }
    </style>
</head>
<body>

<div class="card">
    <h2>Arduino åƒæ•¸è¨­å®š</h2>
    
    <div style="text-align: right; margin-bottom: 1rem;">
        <button id="btnConnect">ğŸ”Œ é€£æ¥è¨­å‚™</button>
    </div>

    <div id="settingsPanel" style="opacity: 0.5; pointer-events: none;">
        <div class="form-group">
            <label for="ssid">WiFi SSID (å­—ä¸²):</label>
            <input type="text" id="ssid" placeholder="è¼¸å…¥ WiFi åç¨±">
        </div>
        <div class="form-group">
            <label for="baud">Baud Rate (æ•¸å€¼):</label>
            <input type="number" id="baud" value="9600">
        </div>
        <div class="form-group">
            <label for="memo">å‚™è¨» (Memo):</label>
            <input type="text" id="memo" placeholder="ä»»æ„å‚™è¨»">
        </div>
        
        <button id="btnSave" disabled>ğŸ’¾ å„²å­˜è¨­å®šåˆ° Flash</button>
    </div>

    <div id="status"></div>
    
    <div class="log" id="logArea"></div>
</div>

<script>
    let port;
    let writer;
    let reader;
    let keepReading = false;
    let inputBuffer = "";

    const btnConnect = document.getElementById('btnConnect');
    const btnSave = document.getElementById('btnSave');
    const settingsPanel = document.getElementById('settingsPanel');
    const statusDiv = document.getElementById('status');
    const logArea = document.getElementById('logArea');

    // 1. é€£æ¥ Serial Port
    btnConnect.addEventListener('click', async () => {
        if ("serial" in navigator) {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 }); // éœ€èˆ‡ Arduino ç¨‹å¼ä¸€è‡´
                
                // UI ç‹€æ…‹æ›´æ–°
                btnConnect.textContent = "âœ… å·²é€£æ¥";
                btnConnect.disabled = true;
                settingsPanel.style.opacity = "1";
                settingsPanel.style.pointerEvents = "auto";
                btnSave.disabled = false;
                
                // é–‹å§‹ç›£è½ Arduino å›å‚³çš„æ•¸æ“š
                keepReading = true;
                readLoop();
                
                log("å·²é€£æ¥åˆ° Serial Port");
            } catch (err) {
                console.error(err);
                alert("é€£æ¥å¤±æ•—æˆ–ä½¿ç”¨è€…å–æ¶ˆ");
            }
        } else {
            alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Web Serial API (è«‹ä½¿ç”¨ Chrome/Edge)");
        }
    });

    // 2. ç™¼é€æ•¸æ“š (JSON)
    btnSave.addEventListener('click', async () => {
        if (!port || !port.writable) return;

        const data = {
            ssid: document.getElementById('ssid').value,
            baud: parseInt(document.getElementById('baud').value),
            memo: document.getElementById('memo').value
        };

        const jsonString = JSON.stringify(data);
        log(`ç™¼é€æ•¸æ“š: ${jsonString}`);
        showStatus("æ­£åœ¨å„²å­˜...", "normal");

        const textEncoder = new TextEncoder();
        const writer = port.writable.getWriter();
        
        // Arduino è®€å– readStringUntil('\n')ï¼Œæ‰€ä»¥çµå°¾å¿…é ˆåŠ æ›è¡Œç¬¦è™Ÿ
        await writer.write(textEncoder.encode(jsonString + "\n"));
        writer.releaseLock();
    });

    // 3. è®€å–æ•¸æ“š (ç›£è½å›å‚³)
    async function readLoop() {
        const textDecoder = new TextDecoderStream();
        const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
        const reader = textDecoder.readable.getReader();

        try {
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                
                if (value) {
                    handleSerialData(value);
                }
            }
        } catch (error) {
            console.error(error);
        } finally {
            reader.releaseLock();
        }
    }

    // è™•ç†æ¥æ”¶åˆ°çš„ç‰‡æ®µæ•¸æ“š (è™•ç†æ–·è¡Œ)
    function handleSerialData(chunk) {
        inputBuffer += chunk;
        
        // æª¢æŸ¥æ˜¯å¦æœ‰æ›è¡Œç¬¦è™Ÿ (Arduino ç”¨ println çµå°¾)
        let eolIndex;
        while ((eolIndex = inputBuffer.indexOf('\n')) >= 0) {
            const line = inputBuffer.slice(0, eolIndex).trim();
            inputBuffer = inputBuffer.slice(eolIndex + 1);
            
            if (line.length > 0) {
                parseArduinoResponse(line);
            }
        }
    }

    // 4. è§£æ Arduino å›å‚³çš„ JSON ä¸¦é¡¯ç¤ºçµæœ
    function parseArduinoResponse(jsonStr) {
        log(`æ”¶åˆ°å›æ‡‰: ${jsonStr}`);
        try {
            const response = JSON.parse(jsonStr);
            
            if (response.status === "success") {
                // é€™è£¡ä¿®æ”¹é¡¯ç¤ºé‚è¼¯ï¼ŒæŠŠå¾ Flash è®€å›ä¾†çš„è³‡æ–™é¡¯ç¤ºå‡ºä¾†
                let msg = `âœ… å„²å­˜ä¸¦é©—è­‰æˆåŠŸï¼\n`;
                msg += `è®€å› SSID: ${response.read_ssid}\n`;
                msg += `è®€å› Baud: ${response.read_baud}\n`;
                msg += `è®€å› Memo: ${response.read_memo}`;
                
                showStatus(msg, "success");
                
                // ä¹Ÿå¯ä»¥åœ¨ Log å€å†å°ä¸€æ¬¡è©³ç´°è³‡è¨Š
                log("--- Flash é©—è­‰è³‡æ–™ ---");
                log(`SSID: ${response.read_ssid}`);
                log(`Baud: ${response.read_baud}`);
                log(`Memo: ${response.read_memo}`);
                log("----------------------");

            } else if (response.status === "error") {
                showStatus(`âŒ éŒ¯èª¤: ${response.msg}`, "error");
            }
        } catch (e) {
            console.log("é JSON è¨Šæ¯:", jsonStr);
        }
    }

    function showStatus(msg, type) {
        statusDiv.style.display = 'block';
        statusDiv.textContent = msg;
        statusDiv.className = type === 'success' ? 'success' : (type === 'error' ? 'error' : '');
        
        // 3ç§’å¾Œè‡ªå‹•éš±è—æˆåŠŸè¨Šæ¯
        if (type === 'success') {
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
    }

    function log(msg) {
        logArea.textContent += `> ${msg}\n`;
        logArea.scrollTop = logArea.scrollHeight; // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
    }
</script>

</body>
</html>
